rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Businesses - Only owner can read/write
    match /businesses/{businessId} {
      allow read, write: if request.auth.uid == resource.data.ownerId;
      
      // Members - Users can read own member doc, admins can manage
      match /members/{userId} {
        allow read: if request.auth.uid == userId || 
                       get(/databases/$(database)/documents/businesses/$(businessId)/members/$(request.auth.uid)).data.role == 'admin';
        allow write: if get(/databases/$(database)/documents/businesses/$(businessId)/members/$(request.auth.uid)).data.role == 'admin';
      }
      
      // Tickets - Members can read based on role, managers/staff can update their assignments
      match /tickets/{ticketId} {
        allow read: if exists(/databases/$(database)/documents/businesses/$(businessId)/members/$(request.auth.uid));
        allow create: if exists(/databases/$(database)/documents/businesses/$(businessId)/members/$(request.auth.uid));
        allow update: if (
          // Managers can update tickets in their department
          get(/databases/$(database)/documents/businesses/$(businessId)/members/$(request.auth.uid)).data.role == 'manager' &&
          get(/databases/$(database)/documents/businesses/$(businessId)/members/$(request.auth.uid)).data.department == resource.data.department
        ) || (
          // Staff can update their assigned tickets
          resource.data.assignedTo == request.auth.uid
        ) || (
          // Admins can update any ticket
          get(/databases/$(database)/documents/businesses/$(businessId)/members/$(request.auth.uid)).data.role == 'admin'
        );
      }
    }
    
    // Invites - Must be created and used by business owner/admin
    match /invites/{inviteId} {
      allow create: if request.auth != null;
      allow read, update: if request.auth.uid == resource.data.createdBy || 
                             request.auth.uid == get(/databases/$(database)/documents/businesses/$(resource.data.businessId)/members/$(request.auth.uid)).data.userId;
    }
    
    // Allow all authenticated users to create new invites
    allow create: if request.auth != null;
  }
}
